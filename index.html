<!doctype html>
<html lang="en" dir="ltr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Real-time Analytics</title>
  <style>
    :root{ --bg:#0b1020;--card:#121933cc;--accent:#6ee7ff;--accent2:#a78bfa;--ok:#10b981;--bad:#ef4444;--muted:#9aa3b2;--grid:#1e2749; }
    *{box-sizing:border-box; -webkit-tap-highlight-color: transparent}
    html{height:100%; font-size:16px}
    body{ min-height:100%; margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Inter,Arial; color:#e6e9ef;
      background: radial-gradient(1000px 600px at 10% -10%, #1b2455, transparent),
                  radial-gradient(900px 600px at 110% 20%, #1b3a5a, transparent),
                  linear-gradient(180deg,#0b1020,#0a0f1d 60%);} 
    /* iOS/Telegram WebView: remove native look so <select> works reliably */
    select,button,input,textarea{-webkit-appearance:none;appearance:none;background-color:#0d1328}
    .container{max-width:980px;margin:40px auto;padding:0 20px}
    .card{background:var(--card);backdrop-filter:blur(8px);border:1px solid #2a3357;border-radius:20px;padding:24px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .topbar{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:8px}
    h1{font-size:clamp(20px,5vw,34px);margin:0}
    .lang-select{min-width:220px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .field{grid-column:span 12}
    @media (min-width:800px){.field.sm-6{grid-column:span 6}.field.sm-4{grid-column:span 4}.field.sm-3{grid-column:span 3}}
    label{display:block;font-size:14px;color:#c6cce0;margin:0 0 8px}
    select,button{width:100%;padding:14px 16px;border-radius:12px;border:1px solid #2d365f;color:#e6e9ef;font-size:16px;min-height:48px}
    select:focus,button:focus{outline:2px solid #2aa9ff33}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .btn{cursor:pointer;transition:.18s transform ease,.18s background-color ease;font-weight:600}
    .btn:hover{transform:translateY(-1px)}.btn:active{transform:none}.btn:disabled{opacity:.5;cursor:not-allowed}
    .btn-primary{background:linear-gradient(135deg,var(--accent),var(--accent2));border:0;color:#04121a}
    .btn-outline{background:transparent}
    .result{margin-top:20px;padding:18px;border-radius:16px;border:1px solid #33406d;background:#0e152f}
    .badge{display:inline-flex;align-items:center;gap:8px;font-weight:800;padding:8px 14px;border-radius:999px;letter-spacing:.3px}
    .buy{background:#0e2e1f;color:#7ef2b3;border:1px solid #1d5e41;box-shadow:0 0 0 rgba(16,185,129,.0);animation:glowUp 1.6s ease-in-out infinite}
    .sell{background:#2e1313;color:#ff9ea1;border:1px solid #6e2326;box-shadow:0 0 0 rgba(239,68,68,.0);animation:glowDown 1.6s ease-in-out infinite}
    @keyframes glowUp{0%,100%{box-shadow:0 0 0 0 rgba(16,185,129,.0)}50%{box-shadow:0 0 30px 4px rgba(16,185,129,.35)}}
    @keyframes glowDown{0%,100%{box-shadow:0 0 0 0 rgba(239,68,68,.0)}50%{box-shadow:0 0 30px 4px rgba(239,68,68,.35)}}
    .meta{color:#a9b0c3;font-size:14px}
    .just{margin:12px 0 0;line-height:1.55}
    /* CHART */
    .chart-wrap{margin-top:16px}
    .chart{position:relative;height:220px;border:1px solid #2a3357;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.0)),repeating-linear-gradient(0deg, transparent, transparent 28px, rgba(255,255,255,.05) 28px, rgba(255,255,255,.05) 29px),#0b122a;overflow:hidden}
    .chart canvas{position:absolute;inset:0;width:100%;height:100%}
    .trend-label{position:absolute;inset:auto 12px 12px auto;padding:6px 10px;font-size:12px;border-radius:999px;background:#0d1328;border:1px solid #2a3357;color:#c8d0e5;opacity:.9}
    @media (max-width:600px){.container{margin:16px auto;padding:0 12px}.card{padding:16px;border-radius:16px}.grid{gap:12px}.sticky-actions{position:sticky;bottom:0;left:0;right:0;padding:12px;margin-top:8px;border-top:1px solid #2a3357;background:linear-gradient(180deg, rgba(13,19,40,0.0), rgba(13,19,40,0.35) 10%, rgba(13,19,40,0.85));backdrop-filter:blur(6px);padding-bottom:calc(env(safe-area-inset-bottom,0px) + 12px);border-bottom-left-radius:12px;border-bottom-right-radius:12px}.mobile-stack>*{flex:1 1 100%}.lang-select{min-width:unset;width:100%}.topbar{flex-direction:column;align-items:flex-start}}
    @media (prefers-reduced-motion:reduce){.btn{transition:none}}
  </style>
</head>
<body>
  <div class="container">
    <div class="card">
      <div class="topbar">
        <h1 id="title">Real-time Analytics</h1>
        <select id="lang" class="lang-select" aria-label="Language">
          <option value="en">üá∫üá∏ English</option>
          <option value="ru">üá∑üá∫ –†—É—Å—Å–∫–∏–π</option>
          <option value="es">üá™üá∏ Espa√±ol</option>
          <option value="fr">üá´üá∑ Fran√ßais</option>
          <option value="ar">üá∏üá¶ ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
        </select>
      </div>

      <div class="grid" id="controls">
        <div class="field sm-4">
          <label for="broker" id="lbl-broker">Broker</label>
          <select id="broker"></select>
        </div>
        <div class="field sm-4">
          <label for="pair" id="lbl-pair">Currency Pair (OTC)</label>
          <select id="pair"></select>
        </div>
        <div class="field sm-4">
          <label for="tf" id="lbl-tf">Timeframe</label>
          <select id="tf"></select>
        </div>
        <div class="field sm-3">
          <label for="indicator" id="lbl-ind">Indicator for Rationale</label>
          <select id="indicator"></select>
        </div>
        <div class="field sm-6" style="align-self:end">
          <div class="row sticky-actions mobile-stack">
            <button id="start" class="btn btn-primary">Start</button>
            <button id="again" class="btn btn-outline" disabled>Get new signal</button>
          </div>
        </div>
      </div>

      <div id="out"></div>

      <div class="chart-wrap">
        <div class="chart" id="chart">
          <canvas id="c"></canvas>
          <div class="trend-label" id="trendLabel">‚Äî</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Enable touch handling in iOS/Telegram WebView (select fix)
    document.addEventListener('touchstart', function(){}, {passive:true});

    // --------- I18N ---------
    const I18N = {
      en: { flag:'üá∫üá∏', name:'English', locale:'en-US', dir:'ltr', title:'Real-time Analytics', labels:{broker:'Broker', pair:'Currency Pair (OTC)', tf:'Timeframe', ind:'Indicator for Rationale'}, buttons:{start:'Start', again:'Get new signal'}, indNames:{AUTO:'Auto (random)', MACD:'MACD', STOCH:'Stochastic', RSI:'RSI', WILL:'Williams %R', BBAN:'Bollinger Bands'}, result:{buy:'BUY', sell:'SELL', indicator:'Indicator', reason:'Rationale', nextIn:'Next update in', ready:'Ready'}, ph:{ bull:'bullish', bear:'bearish', high:'local high', low:'local low', sto:{overb:'overbought', overs:'oversold', mid:'mid-range', cross:'signal cross', div:'divergence vs price', exit:'exit from zone'}, rsi:{overb:'overbought', overs:'oversold', bal:'balance', r50:'bounce from 50', hdiv:'hidden divergence', brk:'break of local level'}, will:{overb:'overbought', overs:'oversold', neutral:'neutral zone', exit:'exit from extreme zone', post:'signal after consolidation', ret:'retest of level'}, bban:{upper:'upper', middle:'middle', lower:'lower', squeeze:'squeeze ‚Üí possible impulse', bounce:'bounce from band', break:'breakout and hold'} } },
      ru: { flag:'üá∑üá∫', name:'–†—É—Å—Å–∫–∏–π', locale:'ru-RU', dir:'ltr', title:'–ê–Ω–∞–ª–∏—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏', labels:{broker:'–ë—Ä–æ–∫–µ—Ä', pair:'–í–∞–ª—é—Ç–Ω–∞—è –ø–∞—Ä–∞ (OTC)', tf:'–¢–∞–π–º—Ñ—Ä–µ–π–º', ind:'–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –¥–ª—è –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏—è'}, buttons:{start:'–°—Ç–∞—Ä—Ç', again:'–ü–æ–ª—É—á–∏—Ç—å –Ω–æ–≤—ã–π —Å–∏–≥–Ω–∞–ª'}, indNames:{AUTO:'–ê–≤—Ç–æ–≤—ã–±–æ—Ä (—Å–ª—É—á–∞–π–Ω—ã–π)', MACD:'MACD', STOCH:'–°—Ç–æ—Ö–∞—Å—Ç–∏–∫', RSI:'RSI', WILL:'Williams %R', BBAN:'–ü–æ–ª–æ—Å—ã –ë–æ–ª–ª–∏–Ω–¥–∂–µ—Ä–∞'}, result:{buy:'BUY / –ü–æ–∫—É–ø–∫–∞', sell:'SELL / –ü—Ä–æ–¥–∞–∂–∞', indicator:'–ò–Ω–¥–∏–∫–∞—Ç–æ—Ä', reason:'–û–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ', nextIn:'–û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑', ready:'–ì–æ—Ç–æ–≤–æ'}, ph:{ bull:'–±—ã—á—å–∏–º', bear:'–º–µ–¥–≤–µ–∂—å–∏–º', high:'–º–∞–∫—Å–∏–º—É–º–µ', low:'–º–∏–Ω–∏–º—É–º–µ', sto:{overb:'–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç–∏', overs:'–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç–∏', mid:'—Å–µ—Ä–µ–¥–∏–Ω–µ –¥–∏–∞–ø–∞–∑–æ–Ω–∞', cross:'—Å–∏–≥–Ω–∞–ª—å–Ω—ã–π –∫—Ä–æ—Å—Å', div:'—Ä–∞—Å—Ö–æ–∂–¥–µ–Ω–∏–µ —Å —Ü–µ–Ω–æ–π', exit:'–≤—ã—Ö–æ–¥ –∏–∑ –∑–æ–Ω—ã'}, rsi:{overb:'–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å', overs:'–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å', bal:'–±–∞–ª–∞–Ω—Å', r50:'–æ—Ç–±–æ–π –æ—Ç —É—Ä–æ–≤–Ω—è 50', hdiv:'—Å–∫—Ä—ã—Ç–∞—è –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è', brk:'–ø—Ä–æ–±–æ–π –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–≤–Ω—è'}, will:{overb:'–ø–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å', overs:'–ø–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å', neutral:'–Ω–µ–π—Ç—Ä–∞–ª—å–Ω–∞—è –∑–æ–Ω–∞', exit:'–≤—ã—Ö–æ–¥ –∏–∑ —ç–∫—Å—Ç—Ä–µ–º–∞–ª—å–Ω–æ–π –∑–æ–Ω—ã', post:'—Å–∏–≥–Ω–∞–ª –ø–æ—Å–ª–µ –∫–æ–Ω—Å–æ–ª–∏–¥–∞—Ü–∏–∏', ret:'—Ä–µ—Ç–µ—Å—Ç —É—Ä–æ–≤–Ω—è'}, bban:{upper:'–≤–µ—Ä—Ö–Ω–µ–π', middle:'—Å—Ä–µ–¥–Ω–µ–π', lower:'–Ω–∏–∂–Ω–µ–π', squeeze:'—Å–∂–∞—Ç–∏–µ ‚Üí –≤–æ–∑–º–æ–∂–µ–Ω –∏–º–ø—É–ª—å—Å', bounce:'–æ—Ç–±–æ–π –æ—Ç –≥—Ä–∞–Ω–∏—Ü—ã', break:'–ø—Ä–æ–±–æ–π –∏ –∑–∞–∫—Ä–µ–ø–ª–µ–Ω–∏–µ'} } },
      es: { flag:'üá™üá∏', name:'Espa√±ol', locale:'es-ES', dir:'ltr', title:'Anal√≠tica en tiempo real', labels:{broker:'Br√≥ker', pair:'Par de divisas (OTC)', tf:'Temporalidad', ind:'Indicador para la justificaci√≥n'}, buttons:{start:'Iniciar', again:'Nueva se√±al'}, indNames:{AUTO:'Auto (aleatorio)', MACD:'MACD', STOCH:'Estoc√°stico', RSI:'RSI', WILL:'Williams %R', BBAN:'Bandas de Bollinger'}, result:{buy:'COMPRA', sell:'VENTA', indicator:'Indicador', reason:'Justificaci√≥n', nextIn:'Siguiente en', ready:'Listo'}, ph:{ bull:'alcista', bear:'bajista', high:'m√°ximo local', low:'m√≠nimo local', sto:{overb:'sobrecompra', overs:'sobreventa', mid:'zona media', cross:'cruce de se√±al', div:'divergencia con el precio', exit:'salida de la zona'}, rsi:{overb:'sobrecompra', overs:'sobreventa', bal:'equilibrio', r50:'rebote desde 50', hdiv:'divergencia oculta', brk:'ruptura del nivel local'}, will:{overb:'sobrecompra', overs:'sobreventa', neutral:'zona neutral', exit:'salida de zona extrema', post:'se√±al tras consolidaci√≥n', ret:'retest del nivel'}, bban:{upper:'banda superior', middle:'banda media', lower:'banda inferior', squeeze:'compresi√≥n ‚Üí posible impulso', bounce:'rebote en la banda', break:'ruptura y consolidaci√≥n'} } },
      fr: { flag:'üá´üá∑', name:'Fran√ßais', locale:'fr-FR', dir:'ltr', title:'Analyse en temps r√©el', labels:{broker:'Courtier', pair:'Paire de devises (OTC)', tf:'Unit√© de temps', ind:'Indicateur pour la justification'}, buttons:{start:'D√©marrer', again:'Nouveau signal'}, indNames:{AUTO:'Auto (al√©atoire)', MACD:'MACD', STOCH:'Stochastique', RSI:'RSI', WILL:'Williams %R', BBAN:'Bandes de Bollinger'}, result:{buy:'ACHAT', sell:'VENTE', indicator:'Indicateur', reason:'Justification', nextIn:'Prochaine mise √† jour dans', ready:'Pr√™t'}, ph:{ bull:'haussier', bear:'baissier', high:'sommet local', low:'creux local', sto:{overb:'surachat', overs:'survente', mid:'zone m√©diane', cross:'croisement de signal', div:'divergence vs prix', exit:'sortie de zone'}, rsi:{overb:'surachat', overs:'survente', bal:'√©quilibre', r50:'rebond sur 50', hdiv:'divergence cach√©e', brk:'cassure du niveau local'}, will:{overb:'surachat', overs:'survente', neutral:'zone neutre', exit:'sortie de la zone extr√™me', post:'signal apr√®s consolidation', ret:'retest du niveau'}, bban:{upper:'bande sup√©rieure', middle:'bande m√©diane', lower:'bande inf√©rieure', squeeze:'resserrement ‚Üí impulsion possible', bounce:'rebond sur la bande', break:'cassure et consolidation'} } },
      ar: { flag:'üá∏üá¶', name:'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', locale:'ar-EG', dir:'rtl', title:'ÿ™ÿ≠ŸÑŸäŸÑÿßÿ™ ŸÅŸàÿ±Ÿäÿ©', labels:{broker:'ÿßŸÑŸàÿ≥Ÿäÿ∑', pair:'ÿ≤Ÿàÿ¨ ÿßŸÑÿπŸÖŸÑÿßÿ™ (OTC)', tf:'ÿßŸÑÿ•ÿ∑ÿßÿ± ÿßŸÑÿ≤ŸÖŸÜŸä', ind:'ÿßŸÑŸÖÿ§ÿ¥ÿ± ŸÑŸÑÿ™ÿ®ÿ±Ÿäÿ±'}, buttons:{start:'ÿ®ÿØÿ°', again:'ÿ•ÿ¥ÿßÿ±ÿ© ÿ¨ÿØŸäÿØÿ©'}, indNames:{AUTO:'ÿ™ŸÑŸÇÿßÿ¶Ÿä (ÿπÿ¥Ÿàÿßÿ¶Ÿä)', MACD:'MACD', STOCH:'ÿ≥ÿ™ŸàŸÉÿßÿ≥ÿ™ŸäŸÉ', RSI:'RSI', WILL:'Williams %R', BBAN:'ÿ®ŸàŸÑŸÜÿ¨ÿ± ÿ®ÿßŸÜÿØÿ≤'}, result:{buy:'ÿ¥ÿ±ÿßÿ°', sell:'ÿ®Ÿäÿπ', indicator:'ÿßŸÑŸÖÿ§ÿ¥ÿ±', reason:'ÿßŸÑÿ™ÿ®ÿ±Ÿäÿ±', nextIn:'ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ÿßŸÑŸä ÿÆŸÑÿßŸÑ', ready:'ÿ¨ÿßŸáÿ≤'}, ph:{ bull:'ÿ™ŸÇÿßÿ∑ÿπ ÿµÿßÿπÿØ', bear:'ÿ™ŸÇÿßÿ∑ÿπ Ÿáÿßÿ®ÿ∑', high:'ŸÇŸÖÿ© ŸÖÿ≠ŸÑŸäÿ©', low:'ŸÇÿßÿπ ŸÖÿ≠ŸÑŸä', sto:{overb:'ÿ™ÿ¥ÿ®ÿπ ÿ¥ÿ±ÿßÿ¶Ÿä', overs:'ÿ™ÿ¥ÿ®ÿπ ÿ®ŸäÿπŸä', mid:'ŸÖŸÜÿ∑ŸÇÿ© ŸÖÿ™Ÿàÿ≥ÿ∑ÿ©', cross:'ÿ™ŸÇÿßÿ∑ÿπ ÿ•ÿ¥ÿßÿ±ÿ©', div:'ÿßŸÜÿ≠ÿ±ÿßŸÅ ŸÖÿπ ÿßŸÑÿ≥ÿπÿ±', exit:'ÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©'}, rsi:{overb:'ÿ™ÿ¥ÿ®ÿπ ÿ¥ÿ±ÿßÿ¶Ÿä', overs:'ÿ™ÿ¥ÿ®ÿπ ÿ®ŸäÿπŸä', bal:'ÿ™Ÿàÿßÿ≤ŸÜ', r50:'ÿßÿ±ÿ™ÿØÿßÿØ ŸÖŸÜ 50', hdiv:'ÿßŸÜÿ≠ÿ±ÿßŸÅ ŸÖÿÆŸÅŸä', brk:'ÿßÿÆÿ™ÿ±ÿßŸÇ ŸÖÿ≥ÿ™ŸàŸâ ŸÖÿ≠ŸÑŸä'}, will:{overb:'ÿ™ÿ¥ÿ®ÿπ ÿ¥ÿ±ÿßÿ¶Ÿä', overs:'ÿ™ÿ¥ÿ®ÿπ ÿ®ŸäÿπŸä', neutral:'ŸÖŸÜÿ∑ŸÇÿ© ÿ≠ŸäÿßÿØŸäÿ©', exit:'ÿÆÿ±Ÿàÿ¨ ŸÖŸÜ ŸÖŸÜÿ∑ŸÇÿ© ŸÖÿ™ÿ∑ÿ±ŸÅÿ©', post:'ÿ•ÿ¥ÿßÿ±ÿ© ÿ®ÿπÿØ ÿ™ÿ¨ŸÖŸäÿπ', ret:'ÿ•ÿπÿßÿØÿ© ÿßÿÆÿ™ÿ®ÿßÿ± ÿßŸÑŸÖÿ≥ÿ™ŸàŸâ'}, bban:{upper:'ÿßŸÑÿ≠ÿßŸÅÿ© ÿßŸÑÿπŸÑŸäÿß', middle:'ÿßŸÑŸàÿ≥ÿ∑Ÿâ', lower:'ÿßŸÑÿ≥ŸÅŸÑŸâ', squeeze:'ÿßŸÜÿ∂ÿ∫ÿßÿ∑ ‚Üí ÿßÿ≠ÿ™ŸÖÿßŸÑ ÿ≠ÿ±ŸÉÿ© ŸÇŸàŸäÿ©', bounce:'ÿßÿ±ÿ™ÿØÿßÿØ ŸÖŸÜ ÿßŸÑÿ≠ÿØ', break:'ÿßÿÆÿ™ÿ±ÿßŸÇ Ÿàÿ™ÿ£ŸÉŸäÿØ'} } },
    };

    // --------- Brokers data ---------
    const BROKERS = {
      'Pocket Option': { pairs:['EUR/USD','GBP/USD','USD/JPY','USD/CHF','AUD/USD','BTC/USD'], tfs:['15s','30s','1m','2m','5m'] },
      'IQ Option':     { pairs:['EUR/USD','GBP/USD','AUD/CAD','USD/CHF','EUR/JPY','GBP/JPY'], tfs:['30s','1m','5m','15m'] },
      'Binomo':        { pairs:['EUR/USD','USD/JPY','GBP/USD','USD/CAD','EUR/GBP'],          tfs:['1m','5m','15m'] },
      'Bubinga':       { pairs:['EUR/USD','GBP/JPY','AUD/JPY','USD/TRY','BTC/USD'],          tfs:['30s','1m','2m','5m'] },
      'Quotex':        { pairs:['EUR/USD','GBP/USD','USD/JPY','EUR/JPY','NZD/USD','BTC/USD'],tfs:['30s','1m','2m','5m','10m'] }
    };

    // --------- Elements ---------
    const titleEl = document.getElementById('title');
    const langEl  = document.getElementById('lang');
    const brokerEl = document.getElementById('broker');
    const pairEl   = document.getElementById('pair');
    const tfEl     = document.getElementById('tf');
    const indicatorEl = document.getElementById('indicator');
    const startBtn = document.getElementById('start');
    const againBtn = document.getElementById('again');
    const outEl    = document.getElementById('out');

    const lblBroker = document.getElementById('lbl-broker');
    const lblPair   = document.getElementById('lbl-pair');
    const lblTf     = document.getElementById('lbl-tf');
    const lblInd    = document.getElementById('lbl-ind');

    // Chart elements
    const chartEl = document.getElementById('chart');
    const c = document.getElementById('c');
    const trendLabel = document.getElementById('trendLabel');
    const ctx = c.getContext('2d');
    let raf = null; // animation frame id

    // Cache for sticky signals per (broker, pair, tf)
    const SIGNAL_CACHE = new Map(); // key -> {side, ind, reason, ts, expiresAt}

    let currentLang = 'en';
    let lastCfg = null, lastSig = null;

    // countdown
    let countdownTimer = null;

    // --------- Init ---------
    function initBrokers(){
      brokerEl.innerHTML='';
      const names = Object.keys(BROKERS);
      names.forEach((name,i)=>{ const opt=document.createElement('option'); opt.value=name; opt.textContent=name; if(i===0) opt.selected=true; brokerEl.appendChild(opt); });
      if(!brokerEl.options.length){ const opt=document.createElement('option'); opt.value=''; opt.textContent='‚Äî'; brokerEl.appendChild(opt); }
      fillByBroker();
    }
    function fillByBroker(){
      let key = brokerEl.value; if(!BROKERS[key]){ key = Object.keys(BROKERS)[0]; brokerEl.value = key; }
      const b = BROKERS[key]; if(!b) return;
      pairEl.innerHTML=''; b.pairs.forEach((p,i)=>{ const opt=document.createElement('option'); opt.value=p; opt.textContent=`${p} (OTC)`; if(i===0) opt.selected=true; pairEl.appendChild(opt); });
      tfEl.innerHTML=''; b.tfs.forEach((t,i)=>{ const opt=document.createElement('option'); opt.value=t; opt.textContent=t; if(i===0) opt.selected=true; tfEl.appendChild(opt); });
      validateReady();
      handleConfigChange();
    }
    function validateReady(){ const ok = brokerEl.value && pairEl.value && tfEl.value; startBtn.disabled = !ok; }
    brokerEl.addEventListener('change', fillByBroker);
    pairEl.addEventListener('change', handleConfigChange);
    tfEl.addEventListener('change', handleConfigChange);

    // --------- Localization ---------
    function applyLang(lang){
      currentLang = lang; const L = I18N[lang];
      document.documentElement.lang = lang; document.documentElement.dir = L.dir || 'ltr';
      titleEl.textContent = L.title; lblBroker.textContent = L.labels.broker; lblPair.textContent = L.labels.pair; lblTf.textContent = L.labels.tf; lblInd.textContent = L.labels.ind;
      startBtn.textContent = L.buttons.start; againBtn.textContent = L.buttons.again; trendLabel.textContent = '‚Äî';
      const curVal = indicatorEl.value || 'AUTO'; indicatorEl.innerHTML = '';
      ;['AUTO','MACD','STOCH','RSI','WILL','BBAN'].forEach(k=>{ const opt=document.createElement('option'); opt.value=k; opt.textContent=L.indNames[k]; if(k===curVal) opt.selected=true; indicatorEl.appendChild(opt); });
      if(lastCfg && lastSig) { renderResult(lastCfg, lastSig); if(lastSig.expiresAt && Date.now()<lastSig.expiresAt) startCountdownFor(lastCfg, lastSig); }
    }
    langEl.addEventListener('change', (e)=> applyLang(e.target.value));

    // --------- Utilities ---------
    const rnd  = (min,max)=> Math.random()*(max-min)+min;
    const rndi = (min,max)=> Math.floor(rnd(min,max+1));
    const pick = arr => arr[Math.floor(Math.random()*arr.length)];
    const biasSide = ()=> Math.random() < 0.5 ? 'BUY' : 'SELL';
    const formatTime = d => d.toLocaleString((I18N[currentLang]||{}).locale||'en-US',{hour12:false});

    function tfToMs(tf){
      if(!tf) return 60000; // default 1m
      const m = String(tf).match(/^(\d+)([sm])$/i);
      if(!m) return 60000;
      const val = parseInt(m[1],10); const unit = m[2].toLowerCase();
      return unit==='s' ? val*1000 : val*60*1000;
    }
    const cacheKey = (cfg)=> `${cfg.broker}|${cfg.pairValue}|${cfg.tf}`;

    function loadFromStorage(key){
      try{ const raw = localStorage.getItem('sig:'+key); if(!raw) return null; const obj = JSON.parse(raw); if(obj && obj.expiresAt && Date.now() < obj.expiresAt) return obj; }catch{} return null;
    }
    function saveToStorage(key, val){ try{ localStorage.setItem('sig:'+key, JSON.stringify(val)); }catch{} }
    function clearStorage(key){ try{ localStorage.removeItem('sig:'+key); }catch{} }

    function justify(ind){
      const P = I18N[currentLang].ph;
      switch(ind){
        case 'MACD':{
          const macd = (rnd(-2.5,2.5)).toFixed(2);
          const signal = (parseFloat(macd) + rnd(-0.6,0.6)).toFixed(2);
          const cross = Math.random()<0.5 ? P.bull : P.bear;
          const hl = Math.random()<0.5 ? P.high : P.low;
          if(currentLang==='en') return `MACD ${cross} crossover (MACD‚âà${macd}, Signal‚âà${signal}), divergence at a ${hl}.`;
          if(currentLang==='es') return `Cruce ${cross} de MACD (MACD‚âà${macd}, Se√±al‚âà${signal}), divergencia en ${hl}.`;
          if(currentLang==='fr') return `Croisement ${cross} du MACD (MACD‚âà${macd}, Signal‚âà${signal}), divergence sur un ${hl}.`;
          if(currentLang==='ar') return `MACD ${cross} (MACD‚âà${macd}ÿå ÿßŸÑÿ•ÿ¥ÿßÿ±ÿ©‚âà${signal})ÿå ÿßŸÜÿ≠ÿ±ÿßŸÅ ÿπŸÜÿØ ${hl}.`;
          return `MACD ${cross} –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ (MACD‚âà${macd}, Signal‚âà${signal}), –¥–∏–≤–µ—Ä–≥–µ–Ω—Ü–∏—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–º ${hl}.`; }
        case 'STOCH':{
          const k = rndi(5,95);
          const d = Math.min(100, Math.max(0, k + rndi(-8,8)));
          const zone = k>80? P.sto.overb : k<20? P.sto.overs : P.sto.mid;
          const extra = [P.sto.div,P.sto.cross,P.sto.exit][rndi(0,2)];
          if(currentLang==='en') return `Stochastic %K‚âà${k}, %D‚âà${d}, ${zone} zone, ${extra}.`;
          if(currentLang==='es') return `Estoc√°stico %K‚âà${k}, %D‚âà${d}, zona de ${zone}, ${extra}.`;
          if(currentLang==='fr') return `Stochastique %K‚âà${k}, %D‚âà${d}, zone de ${zone}, ${extra}.`;
          if(currentLang==='ar') return `ÿ≥ÿ™ŸàŸÉÿßÿ≥ÿ™ŸäŸÉ %K‚âà${k}ÿå %D‚âà${d}ÿå ŸÖŸÜÿ∑ŸÇÿ© ${zone}ÿå ${extra}.`;
          return `Stochastic %K‚âà${k}, %D‚âà${d}, –∑–æ–Ω–∞ ${zone}, –Ω–∞–±–ª—é–¥–∞–µ—Ç—Å—è ${extra}.`; }
        case 'RSI':{
          const v = rndi(5,95);
          const zone = v>70? P.rsi.overb : v<30? P.rsi.overs : P.rsi.bal;
          const extra = [P.rsi.r50,P.rsi.hdiv,P.rsi.brk][rndi(0,2)];
          if(currentLang==='en') return `RSI‚âà${v} (${zone}), ${extra}.`;
          if(currentLang==='es') return `RSI‚âà${v} (${zone}), ${extra}.`;
          if(currentLang==='fr') return `RSI‚âà${v} (${zone}), ${extra}.`;
          if(currentLang==='ar') return `RSI‚âà${v} (${zone})ÿå ${extra}.`;
          return `RSI‚âà${v} (${zone}), ${extra}.`; }
        case 'WILL':{
          const v = rndi(-100,-1);
          const zone = v>-20? P.will.overb : v<-80? P.will.overs : P.will.neutral;
          const extra = [P.will.exit,P.will.post,P.will.ret][rndi(0,2)];
          if(currentLang==='en') return `Williams %R‚âà${v} (${zone}), ${extra}.`;
          if(currentLang==='es') return `Williams %R‚âà${v} (${zone}), ${extra}.`;
          if(currentLang==='fr') return `Williams %R‚âà${v} (${zone}), ${extra}.`;
          if(currentLang==='ar') return `Williams %R‚âà${v} (${zone})ÿå ${extra}.`;
          return `Williams %R‚âà${v} (${zone}), ${extra}.`; }
        case 'BBAN':{
          const pos = [P.bban.upper,P.bban.middle,P.bban.lower][rndi(0,2)];
          const width = (rnd(1.2,3.5)).toFixed(1);
          const extra = [P.bban.squeeze,P.bban.bounce,P.bban.break][rndi(0,2)];
          if(currentLang==='en') return `Bollinger Bands: price near ${pos} band, width‚âà${width}œÉ, ${extra}.`;
          if(currentLang==='es') return `Bandas de Bollinger: precio en la banda ${pos}, ancho‚âà${width}œÉ, ${extra}.`;
          if(currentLang==='fr') return `Bandes de Bollinger : prix pr√®s de la bande ${pos}, largeur‚âà${width}œÉ, ${extra}.`;
          if(currentLang==='ar') return `ÿ®ŸàŸÑŸÜÿ¨ÿ± ÿ®ÿßŸÜÿØÿ≤: ÿßŸÑÿ≥ÿπÿ± ÿπŸÜÿØ ${pos}ÿå ÿßŸÑÿπÿ±ÿ∂‚âà${width}œÉÿå ${extra}.`;
          return `Bollinger Bands: —Ü–µ–Ω–∞ —É ${pos} –ø–æ–ª–æ—Å—ã, —à–∏—Ä–∏–Ω–∞ –ø–æ–ª–æ—Å‚âà${width}œÉ, ${extra}.`; }
        default:
          return '';
      }
    }

    function getOrCreateSignal(cfg){
      const key = cacheKey(cfg);
      // in-memory first
      let s = SIGNAL_CACHE.get(key);
      if(!s){ s = loadFromStorage(key); if(s) SIGNAL_CACHE.set(key, s); }
      if(s && Date.now() < s.expiresAt){ return s; }
      // create new
      let ind = indicatorEl.value || 'AUTO';
      if(ind==='AUTO') ind = pick(['MACD','STOCH','RSI','WILL','BBAN']);
      const side = biasSide();
      const reason = justify(ind);
      const d = new Date();
      const exp = Date.now() + tfToMs(cfg.tf);
      const sig = { side, ind, reason, ts: formatTime(d), expiresAt: exp };
      SIGNAL_CACHE.set(key, sig); saveToStorage(key, sig);
      return sig;
    }

    function renderResult(cfg, sig){
      const L=I18N[currentLang]; const {broker,pairLabel,tf}=cfg; const badgeClass=sig.side==='BUY'?'buy':'sell'; const title=sig.side==='BUY'?L.result.buy:L.result.sell;
      outEl.innerHTML = `
        <div class="result">
          <div class="row" style="justify-content:space-between; align-items:center">
            <div class="badge ${badgeClass}">${title}</div>
            <div class="meta"><span>${sig.ts}</span> ‚Ä¢ <span id="countdown">${L.result.nextIn} ‚Ä¶</span></div>
          </div>
          <div class="just">
            <strong>${broker}</strong> ‚Ä¢ <strong>${pairLabel}</strong> ‚Ä¢ ${L.labels.tf}: <strong>${tf}</strong><br/>
            ${L.result.indicator}: <strong>${L.indNames[sig.ind]||sig.ind}</strong><br/>
            ${L.result.reason}: ${sig.reason}
          </div>
        </div>`;
    }

    function currentConfig(){
      return {
        broker: brokerEl.value,
        pairValue: pairEl.value,
        pairLabel: pairEl.options[pairEl.selectedIndex]?.text || pairEl.value + ' (OTC)',
        tf: tfEl.value
      };
    }

    function setButtonsLocked(locked){
      if(locked){
        startBtn.disabled = true; againBtn.disabled = true;
      } else {
        const ok = brokerEl.value && pairEl.value && tfEl.value;
        startBtn.disabled = !ok;
        againBtn.disabled = !lastSig;
      }
    }

    function formatDuration(ms){
      let s = Math.max(0, Math.ceil(ms/1000));
      const h = Math.floor(s/3600); s %= 3600; const m = Math.floor(s/60); const ss = s%60;
      return (h? String(h).padStart(2,'0')+':':'') + String(m).padStart(2,'0') + ':' + String(ss).padStart(2,'0');
    }

    function stopCountdown(){ if(countdownTimer){ clearInterval(countdownTimer); countdownTimer=null; } }

    function startCountdownFor(cfg, sig){
      stopCountdown();
      const L = I18N[currentLang];
      const key = cacheKey(cfg);
      function tick(){
        const el = document.getElementById('countdown');
        if(!el){ stopCountdown(); return; }
        const rem = sig.expiresAt - Date.now();
        if(rem <= 0){
          el.textContent = L.result.ready;
          // unlock actions; signal considered expired
          setButtonsLocked(false);
          SIGNAL_CACHE.delete(key); clearStorage(key);
          stopCountdown();
          return;
        }
        el.textContent = `${L.result.nextIn} ${formatDuration(rem)}`;
      }
      countdownTimer = setInterval(tick, 1000);
      tick();
    }

    // --------- Candle chart (BUY/SELL animation) ---------
    const rndF  = (min,max)=> Math.random()*(max-min)+min;
    function resizeCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = chartEl.getBoundingClientRect();
      c.width = Math.floor(rect.width * dpr);
      c.height = Math.floor(rect.height * dpr);
      c.style.width = rect.width + 'px';
      c.style.height = rect.height + 'px';
      ctx.setTransform(dpr,0,0,dpr,0,0);
      drawGrid();
    }
    function drawGrid(){
      const {width, height} = c; const dpr = Math.max(1, window.devicePixelRatio || 1);
      ctx.save(); ctx.setTransform(1,0,0,1,0,0); ctx.clearRect(0,0,width,height); ctx.setTransform(dpr,0,0,dpr,0,0);
      const w = width/dpr, h = height/dpr; ctx.strokeStyle = 'rgba(255,255,255,.07)'; ctx.lineWidth = 1; const stepY = 28;
      for(let y=0; y<h; y+=stepY){ ctx.beginPath(); ctx.moveTo(0,y+.5); ctx.lineTo(w,y+.5); ctx.stroke(); }
      ctx.restore();
    }
    function genCandles(n=60, side='BUY'){
      const data = []; let price = rndF(90,110); const drift = side==='BUY' ? rndF(0.05,0.25) : -rndF(0.05,0.25);
      for(let i=0;i<n;i++){ const vol = rndF(0.5,2.4); const open = price; const delta = drift + rndF(-0.6,0.6); const close = Math.max(10, open + delta); const high = Math.max(open, close) + rndF(0.2,1.4)*vol; const low  = Math.min(open, close) - rndF(0.2,1.4)*vol; price = close; data.push({open,high,low,close}); }
      return data;
    }
    function animateCandles(side){
      cancelAnimationFrame(raf); resizeCanvas();
      const upColor = '#7ef2b3', downColor = '#ff9ea1', outlineUp = '#1d5e41', outlineDown = '#6e2326';
      const data = genCandles(64, side); const w = c.clientWidth, h = c.clientHeight; const pad = 14; const visible = 40; const cw = Math.max(6, Math.floor((w - pad*2) / visible)); const gap = 2;
      const prices = data.flatMap(d=>[d.high,d.low]); const minP = Math.min(...prices), maxP = Math.max(...prices); const px = p => pad + (p - minP) / (maxP - minP + 1e-6) * (h - pad*2);
      let i = 0; trendLabel.textContent = side==='BUY' ? 'BUY' : 'SELL';
      function frame(){ drawGrid(); const start = Math.max(0, i - visible + 1); const slice = data.slice(start, i+1);
        slice.forEach((d, idx)=>{ const x = pad + idx*(cw+gap); const openY = h - px(d.open); const closeY= h - px(d.close); const highY = h - px(d.high); const lowY  = h - px(d.low); const isUp = d.close >= d.open; const col = isUp ? upColor : downColor; const ol  = isUp ? outlineUp : outlineDown; ctx.strokeStyle = col; ctx.lineWidth = 1.2; ctx.beginPath(); ctx.moveTo(x + cw/2, highY); ctx.lineTo(x + cw/2, lowY); ctx.stroke(); const bodyY = Math.min(openY, closeY); const bodyH = Math.max(2, Math.abs(closeY - openY)); ctx.fillStyle = col; ctx.strokeStyle = ol; ctx.lineWidth = 1; roundRect(ctx, x+0.5, bodyY, cw-1, bodyH, 3, true, true); });
        const arrowX = w - 34, arrowY = 22; ctx.fillStyle = side==='BUY' ? upColor : downColor; ctx.strokeStyle = 'rgba(255,255,255,.15)'; ctx.lineWidth=1; ctx.beginPath(); if(side==='BUY'){ ctx.moveTo(arrowX, arrowY+12); ctx.lineTo(arrowX+10, arrowY+2); ctx.lineTo(arrowX+20, arrowY+12); } else { ctx.moveTo(arrowX, arrowY+2); ctx.lineTo(arrowX+10, arrowY+12); ctx.lineTo(arrowX+20, arrowY+2);} ctx.closePath(); ctx.fill(); ctx.stroke(); i++; if(i < data.length-1){ raf = requestAnimationFrame(frame); } }
      raf = requestAnimationFrame(frame);
    }
    function roundRect(ctx, x, y, w, h, r, fill, stroke){ const radius = Math.min(r, w/2, h/2); ctx.beginPath(); ctx.moveTo(x+radius, y); ctx.arcTo(x+w, y, x+w, y+h, radius); ctx.arcTo(x+w, y+h, x, y+h, radius); ctx.arcTo(x, y+h, x, y, radius); ctx.arcTo(x, y, x+w, y, radius); if(fill) ctx.fill(); if(stroke) ctx.stroke(); }

    // --------- Buttons & interactions ---------
    function currentConfig(){
      return {
        broker: brokerEl.value,
        pairValue: pairEl.value,
        pairLabel: pairEl.options[pairEl.selectedIndex]?.text || pairEl.value + ' (OTC)',
        tf: tfEl.value
      };
    }

    startBtn.addEventListener('click', ()=>{
      lastCfg = currentConfig();
      lastSig = getOrCreateSignal(lastCfg);
      renderResult(lastCfg, lastSig);
      setButtonsLocked(true);
      outEl.scrollIntoView({behavior:'smooth', block:'start'});
      animateCandles(lastSig.side);
      startCountdownFor(lastCfg, lastSig);
    });

    againBtn.addEventListener('click', ()=>{
      // Same behavior as Start, but kept for UI parity
      lastCfg = currentConfig();
      lastSig = getOrCreateSignal(lastCfg);
      renderResult(lastCfg, lastSig);
      setButtonsLocked(true);
      outEl.scrollIntoView({behavior:'smooth', block:'start'});
      animateCandles(lastSig.side);
      startCountdownFor(lastCfg, lastSig);
    });

    function handleConfigChange(){
      const cfg = currentConfig();
      const key = cacheKey(cfg);
      let s = SIGNAL_CACHE.get(key) || loadFromStorage(key);
      if(s && Date.now() < s.expiresAt){
        lastCfg = cfg; lastSig = s;
        renderResult(cfg, s);
        setButtonsLocked(true);
        animateCandles(s.side);
        startCountdownFor(cfg, s);
      } else {
        // unlock for new generation on this config
        lastCfg = cfg; lastSig = null; stopCountdown(); trendLabel.textContent='‚Äî';
        setButtonsLocked(false);
        outEl.innerHTML = '';
      }
    }

    // --------- Safe init ---------
    function safeInit(){
      try{
        if(!brokerEl.options.length) initBrokers();
        langEl.value = 'en';
        if(!indicatorEl.options.length) applyLang('en');
        if(!pairEl.options.length || !tfEl.options.length) fillByBroker();
        validateReady();
        resizeCanvas();
        handleConfigChange();
      }catch(e){ console.error('init error', e); }
    }
    if(document.readyState==='loading'){ document.addEventListener('DOMContentLoaded', safeInit, {once:true}); } else { safeInit(); }
    window.addEventListener('resize', ()=>{ resizeCanvas(); if(lastSig) animateCandles(lastSig.side); }, {passive:true});
    ['focus','mousedown','touchstart'].forEach(ev=>{ brokerEl.addEventListener(ev, ()=>{ if(!brokerEl.options.length) safeInit(); }); indicatorEl.addEventListener(ev, ()=>{ if(!indicatorEl.options.length) applyLang(currentLang||'en'); }); });

  </script>
</body>
</html>
